Bootstrap: docker
From: ubuntu:18.04
%help
    Container for LTR_retriever v.2.8
    https://github.com/oushujun/LTR_retriever

    Includes 
    	CD-HIT v.4.8.1, 
    	HMMER v.3.3, 
    	RepeatMasker v.4.1.0, 
    	RMblast v.2.10,
    	TRF v.4.09, 
    	GenomeTools v.1.6 (for LTRharvest), 
    	LTR_Finder v.1.07,
    	LTR_Finder_In_Parallel v.1.1,
    	LtrDetector (no version, one single release)

%labels
    VERSION "LTR_retriever v.2.8"
    Maintainer Francois Sabot <francois.sabot@ird.fr>
    April, 2020

%post
    # faster apt downloads
    export DEBIAN_FRONTEND=noninteractive
    export LC_ALL=C
    (
        . /etc/os-release
        cat << _EOF_ > mirror.txt
deb mirror://mirrors.ubuntu.com/mirrors.txt ${UBUNTU_CODENAME} main restricted universe multiverse
deb mirror://mirrors.ubuntu.com/mirrors.txt ${UBUNTU_CODENAME}-updates main restricted universe multiverse
deb mirror://mirrors.ubuntu.com/mirrors.txt ${UBUNTU_CODENAME}-backports main restricted universe multiverse
deb mirror://mirrors.ubuntu.com/mirrors.txt ${UBUNTU_CODENAME}-security main restricted universe multiverse

_EOF_
        mv /etc/apt/sources.list /etc/apt/sources.list.bak
        cat mirror.txt /etc/apt/sources.list.bak > /etc/apt/sources.list
    )

    # apt dependencies
    apt update
    apt install -y \
    	apt-utils \
        autoconf \
        automake \
        gcc \
        build-essential \
        software-properties-common \
        wget \
        zlib1g-dev \
        ncbi-blast+ \
        wget \
        unzip \
        gzip \
        unzip \
        sudo \
        git-core \
        perl \
        locales \

        
    # build variables
    export PATH="${PATH}:/opt/tools"
    export TOOLDIR=/opt/tools

	#Preparing Directories
	mkdir -p mkdir "${TOOLDIR}"

        
    #install CD-HIT
    
    cd "${TOOLDIR}" || exit 1
    mkdir cdhit && cd cdhit
    wget https://github.com/weizhongli/cdhit/releases/download/V4.8.1/cd-hit-v4.8.1-2019-0228.tar.gz
    tar xvzf cd-hit-v4.8.1-2019-0228.tar.gz
    #Reorganizing and Cleaning
    mv cd-hit-v4.8.1-2019-0228/* .
    rm -Rf cd-hit-v4.8.1-2019-0228
    make
    sudo make install
    
	
	
	#install HMMER
    
    cd "${TOOLDIR}" || exit 1
    mkdir hmmer && cd hmmer
    wget http://eddylab.org/software/hmmer/hmmer-3.3.tar.gz
    tar xvzf hmmer-3.3.tar.gz
    #Reorganizing and Cleaning
    mv hmmer-3.3/* .
    rm -Rf hmmer-3.3
    ./configure
    make
    sudo make install
    
    
    #install TRF
    
    cd "${TOOLDIR}" || exit 1
    mkdir trf && cd trf
    wget http://tandem.bu.edu/trf/downloads/trf409.linux64
    sudo cp trf409.linux64 /usr/local/bin/trf
    sudo chmod 775 /usr/local/bin/trf
    
    
    #install RMblast
    
    cd "${TOOLDIR}" || exit 1
    mkdir rmblast && cd rmblast
    wget http://www.repeatmasker.org/rmblast-2.10.0+-x64-linux.tar.gz
    sudo cp rmblast-2.10.0+-x64-linux.tar.gz /usr/local/.
    cd /usr/local/
    sudo tar xvzf rmblast-2.10.0+-x64-linux.tar.gz
    sudo mv rmblast-2.10.0 rmblast
    
    
    #install RepeatMasker
    
    cd "${TOOLDIR}" || exit 1
    # prerequisites
    sudo cpan -i Text::Soundex
    mkdir RepeatMasker && cd RepeatMasker
    wget http://www.repeatmasker.org/RepeatMasker-4.1.0.tar.gz
    sudo cp RepeatMasker-4.1.0.tar.gz /usr/local/.
    cd /usr/local
    sudo tar xzvf RepeatMasker-4.1.0.tar.gz
    cd /usr/local/RepeatMasker
    sudo perl ./configure -trf_prgm /usr/local/bin/trf -hmmer_dir /usr/bin/ -rmblast_dir /usr/local/rmblast/bin -default_search_engine rmblast
    
	
	# install GenomeTools for LTRharvest
    
    cd "${TOOLDIR}" || exit 1
    mkdir GenomeTools && cd GenomeTools
    wget http://genometools.org/pub/binary_distributions/gt-1.6.0-Linux_x86_64_x86_64-64bit.tar.gz
    tar xvzf gt-1.6.0-Linux_x86_64_x86_64-64bit.tar.gz
    cd  gt-1.6.0-Linux_x86_64_x86_64-64bit/bin
    sudo ln -s  $TOOLDIR/GenomeTools/gt-1.6.0-Linux_x86_64_x86_64-64bit/bin/gt /usr/local/bin/gt
    
    
    # install LTR_FINDER et LTR_FINDER in parallel
    
    cd "${TOOLDIR}" || exit 1
    mkdir LTR_FINDER_inParallel && cd LTR_FINDER_inParallel
    wget https://github.com/oushujun/LTR_FINDER_parallel/archive/v1.1.tar.gz
    tar xvzf v1.1.tar.gz
    cd  LTR_FINDER_parallel-1.1
    
    # install LtrDetector
    
    cd "${TOOLDIR}" || exit 1
    git clone https://github.com/TulsaBioinformaticsToolsmith/LtrDetector.git
    cd LtrDetector
    cd src
    make bin
    make tr -j
    
    
    

    # install LTRretriever 
    
    cd "${TOOLDIR}" || exit 1
    mkdir LTRretriever && cd LTRretriever
    wget https://github.com/oushujun/LTR_retriever/archive/v2.8.tar.gz
    tar xvzf v2.8.tar.gz
    cd LTR_retriever-2.8
    TEXT="##This file will provide LTR_retriever paths to dependent programs.\n
##You can leave the respective paths empty if programs are accessible through ENV (i.e. exported to .bashrc)\n
##If you specify a path, please make sure that the required program(s) is directly contained in that path but not in any child directories.\n
##e.g. BLAST+=/opt/software/BLAST+/2.2.30--GCC-4.4.5/bin/\n
##LTR_retriever is build based on GenomeTools/1.5.4, BLAST+/2.2.28, BLAST/2.2.26, CDHIT/4.6.1c, HMMER/3.1b2, RepeatMasker/4.0.0 and Tandem Repeats Finder 4.07b\n
\n
BLAST+=/usr/bin 	#a path that contains makeblastdb, blastn, blastx\n
RepeatMasker=/usr/local/RepeatMasker	#a path that contains RepeatMasker\n
HMMER=/usr/bin		#a path that contains hmmsearch\n
CDHIT=/usr/local/bin		#a path that contains cd-hit-est (preferred). CDHIT and BLAST are replaceable\n
BLAST=		#a path that contains blastclust (optional)\n"
	echo -e $TEXT > paths
	
	 #Correcting the Locale error
	 locale-gen fr_FR.UTF-8
	 dpkg-reconfigure locales
    

%environment
	export PATH=$PATH:/usr/local/bin:/usr/bin:/opt/tools/LTRretriever/LTR_retriever-2.8:/opt/tools/LTRretriever/LTR_retriever-2.8/bin/:/usr/local/RepeatMasker:/usr/local/rmblast:/opt/tools/LTR_FINDER_inParallel/LTR_FINDER_parallel-1.1/:/opt/tools/LtrDetector/bin/

    export LANGUAGE=fr_FR.UTF-8
	export LANG=fr_FR.UTF-8
	export LC_ALL=fr_FR.UTF-8
	
%runscript
    exec /bin/bash "$@"

