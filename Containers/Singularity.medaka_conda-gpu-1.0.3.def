BootStrap: docker
From: ubuntu:18.04
%labels
Maintainer Ndomassi Tando - IRD Itrop Cluster, DIADE Unit
base.image="ubuntu:18.04"
version="1"
software="medaka"
software.version="1.0.3"
%help
URL: https://github.com/nanoporetech/medaka
Description: medaka is a tool to create a consensus sequence from nanopore sequencing data
Usage: singularity exec $PATH_TO_CONTAINER/medaka-0.11.5.simg + tools + arguments

%environment
export PATH="/usr/local/miniconda/miniconda3/bin:$PATH"
export PATH="/usr/local/miniconda/miniconda3/envs/medaka/bin:$PATH"
export CONDARC="/.condarc"
export LC_ALL=C

%post

    apt-get -y update
    apt-get -y install bzip2 g++ zlib1g-dev libbz2-dev liblzma-dev libffi-dev libncurses5-dev libcurl4-gnutls-dev libssl-dev curl make cmake wget python3-all-dev python3-pip python-virtualenv
    apt-get -y update
    apt-get -y install gnuplot build-essential perl autoconf autotools-dev libcrypto++6 curl
    apt-get -y update
    apt-get -y install sudo git unzip git-lfs sed bash make
    apt-get -y update


apt update && apt install -y git curl wget less locate build-essential openssh-server
mkdir /usr/local/miniconda && cd /usr/local/miniconda
wget https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh
chmod +x Miniconda3-latest-Linux-x86_64.sh
./Miniconda3-latest-Linux-x86_64.sh -b -p /usr/local/miniconda/miniconda3
cd /usr/local/miniconda/miniconda3/bin
export PATH="/usr/local/miniconda/miniconda3/bin:$PATH" >> $SINGULARITY_ENVIRONMENT
conda config --add channels defaults
conda config --add channels bioconda
conda config --add channels conda-forge
conda create -n medaka -c conda-forge -c bioconda medaka

# installation logiciel

# samtools 1.9
    wget https://github.com/samtools/samtools/releases/download/1.9/samtools-1.9.tar.bz2
    tar xfvj samtools-1.9.tar.bz2
    cd samtools-1.9
    ./configure
    make
    make install
    cd ..

# tabix & BGzip 1.9 (htslib 1.10)
    wget https://github.com/samtools/htslib/releases/download/1.10/htslib-1.10.tar.bz2
    tar xfvj htslib-1.10.tar.bz2
    cd htslib-1.10
    ./configure
    make
    make install
    cd ..


# minimap2 2.11
    wget https://github.com/lh3/minimap2/releases/download/v2.11/minimap2-2.11.tar.bz2
    tar xfvj minimap2-2.11.tar.bz2
    cd minimap2-2.11 && make
    cd ..

# bcftools (1.10.2)
  wget https://github.com/samtools/bcftools/releases/download/1.10.2/bcftools-1.10.2.tar.bz2
  tar xfvj bcftools-1.10.2.tar.bz2
  cd bcftools-1.10.2
  ./configure
  make
  make install
  cd ..

%environment
    export PATH="/minimap2-2.11:/samtools-1.9:/htslib-1.10:/bcftools-1.10.2:${PATH}"

%runscript
exec /bin/bash "$@"
