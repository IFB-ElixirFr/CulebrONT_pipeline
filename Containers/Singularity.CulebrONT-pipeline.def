Bootstrap: docker
From: ubuntu:18.04

%labels
MAINTAINER Julie Orjuela
version="1.0"
software="all Culebront dependencies"
description="All dependencies used to launch CulebrONT in LOCAL mode"
website="https://culebront-pipeline.readthedocs.io/en/latest/"

%help
CulebrONT pipeline singularity container
To run via the wrapper script on LOCAL :
singularity run <image.simg> -c <config path> -k <threads>

To manually run the workflow :
singularity exec <image.simg> snakemake --snakefile /opt/annot_pipeline/Snakefile [other arguments....]

%environment
export CULEBRONT="/usr/local/CulebrONT_pipeline/"
export PATH="/usr/local/miniconda/miniconda3/bin:$PATH"
export PATH="/usr/local/miniconda/miniconda3/envs/snakemake/bin:$PATH"
%post

apt-get update
apt update && apt install -y git curl wget less locate build-essential openssh-server python3-all-dev python3-pip python3-venv
apt install -y graphviz build-essential libssl-dev uuid-dev libgpgme11-dev squashfs-tools libseccomp-dev pkg-config

export DEBIAN_FRONTEND=noninteractive
ln -fs /usr/share/zoneinfo/Europe/Paris /etc/localtime
apt-get install -y tzdata
dpkg-reconfigure --frontend noninteractive tzdata

apt install -y r-recommended r-doc-html util-linux zip
mkdir /usr/local/miniconda && cd /usr/local/miniconda
wget https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh
chmod +x Miniconda3-latest-Linux-x86_64.sh
./Miniconda3-latest-Linux-x86_64.sh -b -p /usr/local/miniconda/miniconda3
cd /usr/local/miniconda/miniconda3/bin
export PATH="/usr/local/miniconda/miniconda3/bin:$PATH" >> $SINGULARITY_ENVIRONMENT

echo 'export LC_ALL=C.UTF-8' >> /environment
echo 'export LANG=C.UTF-8' >> /environment
export LC_ALL=C.UTF-8
export LANG=C.UTF-8
apt -y update
apt install -y rsync gzip libcairo2-dev libxt-dev
apt install -y build-essential zlib1g-dev cmake curl
python3 -m pip install PyYAML
python3 -m pip install pandas
python3 -m pip install seaborn
python3 -m pip install matplotlib
python3 -m pip install tabulate
python3 -m pip install rpy2
python3 -m pip install ipython
python3 -m pip install biopython
python3 -m pip install tqdm pyyaml pysam docopt==0.6.2
python3 -m pip install numpy
python3 -m pip install argparse

conda config --add channels defaults
conda config --add channels bioconda
conda config --add channels conda-forge

conda create -n snakemake
conda install mamba
mamba install snakemake

# installing Singularity
apt install -y singularity-container

# Clone CulebrONT
mkdir -p /usr/local
git clone --recursive https://github.com/SouthGreenPlatform/CulebrONT_pipeline.git /usr/local/CulebrONT_pipeline
cd /usr/local/CulebrONT_pipeline/
git checkout supersingularity

# download build singularity
cd /usr/local/CulebrONT_pipeline/Containers
wget --no-check-certificate -rm -nH --cut-dirs=2 --reject="index.html*" --no-parent https://itrop.ird.fr/culebront_utilities/singularity_build/

# sed toolpath.yaml
cd /usr/local/CulebrONT_pipeline/
sed -i "s|/path/to/|/usr/local/CulebrONT_pipeline/|g" /usr/local/CulebrONT_pipeline/tools_path.yaml

%runscript
exec /usr/local/CulebrONT_pipeline/submit_culebront.sh "$@"



